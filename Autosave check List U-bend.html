<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>U-bend Die Project Timeline</title>
    <!-- Tailwind CSS CDN is allowed via the <script> tag -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        font-family: sans-serif;
      }
      .sticky-header {
        position: sticky;
        top: 0;
        z-index: 10;
        background-color: white; 
        padding-bottom: 1.5rem;
      }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-200 p-4 text-gray-800" onload="appData.init()">

    <div id="app-container" class="max-w-5xl mx-auto rounded-xl shadow-2xl bg-white/70 backdrop-blur-sm p-6 md:p-10 border border-white">
        <div class="sticky-header flex flex-col md:flex-row justify-between items-start md:items-center mb-6 border-b pb-4 border-gray-200">
            <div>
                <h1 class="text-3xl md:text-4xl font-bold text-sky-700 mb-1 leading-tight">U-bend Die Project Timeline</h1>
                <p class="text-sm text-gray-600">Track your progress on the U-Bend Die project.</p>
            </div>
            <div class="flex flex-col md:flex-row items-center space-y-4 md:space-y-0 md:space-x-4 mt-4 md:mt-0">
                <div id="total-duration" class="px-4 py-2 bg-sky-100 text-sky-700 font-semibold rounded-full shadow-md text-sm">
                    Time Remaining: 0 hrs 0 mins
                </div>
                <button onclick="appData.exportToCsv()" class="px-4 py-2 bg-sky-500 text-white rounded-full shadow-lg hover:bg-sky-600 transition-transform transform hover:scale-105 active:scale-95 flex items-center space-x-2 text-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 11.586V3a1 1 0 112 0v8.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                    <span>Export to CSV</span>
                </button>
            </div>
        </div>
        
        <div id="message-container"></div>
        <div id="tasks-list" class="grid gap-6"></div>
    </div>

    <script>
        window.appData = {
            tasks: [
                { id: 'task-1', name: 'Locate and Cut Stock', estimatedDuration: { hours: 0, minutes: 0 }, status: false, materials: 'Band saw', notes: 'Locate the necessary raw material stock and cut it to the unique dimensions for the U-Bend Die.' },
                { id: 'task-2', name: 'Layout and plan/program to make Lower Die', estimatedDuration: { hours: 0, minutes: 0 }, status: false, materials: 'Computer for G&M code', notes: 'Perform layout and machining operations for the lower half of the U-Bend Die.' },
                { id: 'task-3', name: 'Machine Lower Die Half', estimatedDuration: { hours: 0, minutes: 0 }, status: false, materials: 'Mill, CNC Mill', notes: 'Use proper techniques to machine the lower half to print' },
                { id: 'task-4', name: 'Layout and plan/program to make Upper Die', estimatedDuration: { hours: 0, minutes: 0 }, status: false, materials: 'Computer for G&M code', notes: 'Perform layout and machining operations for the upper half of the U-Bend Die.' },
                { id: 'task-5', name: 'Machine Upper Die Half', estimatedDuration: { hours: 0, minutes: 0 }, status: false, materials: 'Mill, CNC Mill', notes: 'Use proper techniques to machine the lower half to print' },
                { id: 'task-6', name: 'Make or Locate Stock Strips', estimatedDuration: { hours: 0, minutes: 0 }, status: false, materials: 'Shear', notes: 'Prepare or find the appropriate stock strips needed for running the part.' },
                { id: 'task-7', name: 'Run Part on Brake Press', estimatedDuration: { hours: 0, minutes: 0 }, status: false, materials: 'Brake press, Instructor', notes: 'Form the part using the brake press with the U-Bend Die.' },
                { id: 'task-8', name: 'Adjustments/Fixes', estimatedDuration: { hours: 0, minutes: 0 }, status: false, materials: 'Computer, machine, and/or tools as needed', notes: 'Make any necessary changes or fixes to correct incorrect aspects of the part or process.' },
                { id: 'task-9', name: 'Hand-in Project', estimatedDuration: { hours: 0, minutes: 0 }, status: false, materials: 'Submit the completed U-Bend Die project.', notes: 'Submit the completed U-Bend Die project.' }
            ],

            init: function() {
                const savedTasks = localStorage.getItem('app-data-tasks');
                if (savedTasks) {
                    try {
                        this.tasks = JSON.parse(savedTasks);
                    } catch (e) {
                        console.error("Error loading tasks from localStorage:", e);
                    }
                }
                this.render();
            },

            save: function() {
                localStorage.setItem('app-data-tasks', JSON.stringify(this.tasks));
            },

            render: function() {
                const tasksList = document.getElementById('tasks-list');
                const totalDurationEl = document.getElementById('total-duration');
                const messageContainer = document.getElementById('message-container');
                tasksList.innerHTML = '';
                let totalMinutes = 0;
                let allTasksCompleted = true;

                this.tasks.forEach(task => {
                    const taskEl = document.createElement('div');
                    taskEl.className = `bg-white rounded-xl shadow-md p-5 flex flex-col sm:flex-row items-start sm:items-center justify-between transition-all duration-300 transform hover:scale-[1.01] border-l-4 ${
                        task.status ? 'border-green-500' : 'border-sky-400'
                    }`;

                    if (!task.status) {
                        allTasksCompleted = false;
                    }

                    const hours = parseInt(task.estimatedDuration.hours, 10) || 0;
                    const minutes = parseInt(task.estimatedDuration.minutes, 10) || 0;
                    if (!task.status) {
                      totalMinutes += (hours * 60) + minutes;
                    }

                    taskEl.innerHTML = `
                        <div class="flex items-start sm:items-center flex-grow">
                            <input type="checkbox" onchange="appData.toggleTaskStatus('${task.id}', this.checked)" ${task.status ? 'checked' : ''} class="h-6 w-6 rounded-full cursor-pointer text-sky-600 border-gray-300 focus:ring-sky-500 mr-4 mt-1 sm:mt-0">
                            <div class="flex-grow">
                                <h3 class="text-lg font-semibold text-gray-900 leading-tight">
                                    ${task.name}
                                </h3>
                                <p class="text-sm text-gray-500 mt-1">
                                    <span class="font-medium text-gray-600">Materials:</span> ${task.materials}
                                </p>
                                <p class="text-xs text-gray-500">
                                    <span class="font-medium text-gray-600">Notes:</span> ${task.notes}
                                </p>
                                <div class="flex items-center mt-2 space-x-2">
                                    <div class="flex items-center space-x-1">
                                        <label for="hours-${task.id}" class="text-sm font-medium text-gray-600">
                                            Est. Duration:
                                        </label>
                                        <input
                                            id="hours-${task.id}"
                                            type="number"
                                            value="${task.estimatedDuration.hours}"
                                            class="w-16 px-2 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500 text-center"
                                            min="0"
                                            onchange="appData.updateDuration('${task.id}', 'hours', this.value)"
                                        />
                                        <span class="text-sm text-gray-600">hrs</span>
                                    </div>
                                    <div class="flex items-center space-x-1">
                                        <input
                                            id="minutes-${task.id}"
                                            type="number"
                                            value="${task.estimatedDuration.minutes}"
                                            class="w-16 px-2 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500 text-center"
                                            min="0"
                                            step="15"
                                            onchange="appData.updateDuration('${task.id}', 'minutes', this.value)"
                                        />
                                        <span class="text-sm text-gray-600">mins</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4 sm:mt-0 sm:ml-4 px-3 py-1 rounded-full text-xs font-semibold ${
                            task.status ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'
                        }">
                            ${task.status ? 'Completed' : 'In Progress'}
                        </div>
                    `;
                    tasksList.appendChild(taskEl);
                });

                const totalHours = Math.floor(totalMinutes / 60);
                const remainingMinutes = totalMinutes % 60;
                totalDurationEl.textContent = `Time Remaining: ${totalHours} hrs ${remainingMinutes} mins`;
                
                const congratsMessage = document.getElementById('congrats-message');
                if (allTasksCompleted && !congratsMessage) {
                    const messageEl = document.createElement('div');
                    messageEl.id = 'congrats-message';
                    messageEl.className = 'text-center bg-green-50 p-6 rounded-lg my-6 border border-green-200';
                    messageEl.innerHTML = '<p class="text-2xl font-bold text-green-600">ðŸŽ‰ Congratulations! You have completed all tasks! ðŸŽ‰</p><p class="mt-2 text-gray-600">Don\'t forget to hand in your project.</p>';
                    messageContainer.appendChild(messageEl);
                } else if (!allTasksCompleted && congratsMessage) {
                    messageContainer.removeChild(congratsMessage);
                }
            },

            updateDuration: function(taskId, field, value) {
                const taskIndex = this.tasks.findIndex(t => t.id === taskId);
                if (taskIndex !== -1) {
                    const sanitizedValue = Math.max(0, parseInt(value, 10) || 0);
                    this.tasks[taskIndex].estimatedDuration[field] = sanitizedValue;
                    this.save();
                    this.render();
                }
            },
            
            toggleTaskStatus: function(taskId, checked) {
                const taskIndex = this.tasks.findIndex(t => t.id === taskId);
                if (taskIndex !== -1) {
                    this.tasks[taskIndex].status = checked;
                    this.save();
                    this.render();
                }
            },

            exportToCsv: function() {
                const totalHours = Math.floor(this.tasks.reduce((sum, task) => (!task.status ? sum + (parseInt(task.estimatedDuration.hours, 10) || 0) * 60 + (parseInt(task.estimatedDuration.minutes, 10) || 0) : sum), 0) / 60);
                const remainingMinutes = this.tasks.reduce((sum, task) => (!task.status ? sum + (parseInt(task.estimatedDuration.hours, 10) || 0) * 60 + (parseInt(task.estimatedDuration.minutes, 10) || 0) : sum), 0) % 60;
                const totalDurationDisplay = `${totalHours} hrs ${remainingMinutes} mins`;
                
                const header = ['Task Name', 'Est. Hours', 'Est. Minutes', 'Status', 'Required Materials', 'Notes'];
                const totalRow = [`"Time Remaining: ${totalDurationDisplay}"`, '', '', '', '', ''].join(',');
                
                const csvRows = this.tasks.map(task => {
                    const csvValues = [
                        `"${task.name}"`,
                        `"${task.estimatedDuration.hours}"`,
                        `"${task.estimatedDuration.minutes}"`,
                        `"${task.status ? 'Completed' : 'In Progress'}"`,
                        `"${task.materials}"`,
                        `"${task.notes.replace(/"/g, '""')}"`
                    ];
                    return csvValues.join(',');
                });
                const csvContent = [totalRow, header.join(','), ...csvRows].join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', `u-bend-die-timeline.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        };
    </script>
</body>
</html>
